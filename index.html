<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Dashboard Absensi Sekolah Profesional</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<script src="https://unpkg.com/html5-qrcode"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
*{margin:0;padding:0;box-sizing:border-box}
body{font-family:'Segoe UI',sans-serif;background:#f4f7fb}

.header{
  background:#1e3c72;
  color:white;
  padding:20px;
  text-align:center;
  font-size:20px;
  font-weight:600;
}

.container{
  max-width:1200px;
  margin:20px auto;
  padding:10px;
}

.cards{
  display:grid;
  grid-template-columns:repeat(auto-fit,minmax(200px,1fr));
  gap:20px;
  margin-bottom:30px;
}

.card{
  background:white;
  padding:20px;
  border-radius:12px;
  box-shadow:0 5px 20px rgba(0,0,0,0.08);
}

.card h3{font-size:14px;color:#777}
.card h2{margin-top:10px;color:#1e3c72}

.section{
  background:white;
  padding:25px;
  border-radius:12px;
  box-shadow:0 5px 20px rgba(0,0,0,0.08);
  margin-bottom:30px;
}

button{
  background:#1e3c72;
  color:white;
  border:none;
  padding:10px 18px;
  border-radius:8px;
  cursor:pointer;
}
button:hover{background:#16325c}

#reader{width:300px;margin:auto}

.status{
  text-align:center;
  margin-top:15px;
  font-weight:600;
}

table{
  width:100%;
  border-collapse:collapse;
  margin-top:20px;
}
th{
  background:#1e3c72;
  color:white;
  padding:10px;
}
td{
  padding:10px;
  border-bottom:1px solid #eee;
  text-align:center;
}

@media(max-width:768px){
  #reader{width:100%}
}
</style>
</head>
<body>

<div class="header">
Dashboard Absensi Sekolah Profesional
</div>

<div class="container">

<div class="cards">
<div class="card">
<h3>Total Kehadiran Bulan Ini</h3>
<h2 id="totalHadir">0</h2>
</div>
<div class="card">
<h3>Total Terlambat Bulan Ini</h3>
<h2 id="totalTerlambat">0</h2>
</div>
</div>

<div class="section">
<h3>Scan QR Absensi</h3>
<div id="reader"></div>
<div class="status" id="status"></div>
</div>

<div class="section">
<h3>Rekap & Grafik Bulanan</h3>
<input type="month" id="bulan">
<button onclick="loadData()">Tampilkan</button>

<canvas id="chart" height="100"></canvas>

<table>
<thead>
<tr>
<th>ID</th>
<th>Nama</th>
<th>Jam</th>
<th>Status</th>
</tr>
</thead>
<tbody id="rekap"></tbody>
</table>
</div>

</div>

<script>

const scriptURL = "https://script.google.com/macros/s/AKfycby4paqsYa_-hTCD1IJ2JNK62kCAVAC4X_FXzaTi1kVH8_gOdnzWmRKNcoSyctz3ekI8Hw/exec";

let chartInstance;

function onScanSuccess(decodedText){
  const data = decodedText.split("|");
  if(data.length < 2){ return; }

  const now = new Date();
  const jam = now.toTimeString().split(" ")[0];
  const batas = "16:00:00";
  const status = (jam > batas) ? "Terlambat" : "Hadir";

  fetch(scriptURL,{
    method:"POST",
    headers:{"Content-Type":"application/json"},
    body:JSON.stringify({
      id:data[0],
      nama:data[1],
      tanggal:now.toISOString().split("T")[0],
      jam:jam,
      status:status
    })
  })
  .then(res=>res.json())
  .then(response=>{
    if(response.status==="sudah_absen"){
      document.getElementById("status").innerText="Siswa sudah absen hari ini";
    }else{
      document.getElementById("status").innerText=
        data[1]+" | "+jam+" | "+status;
    }
    loadData();
  })
  .catch(()=>alert("Gagal kirim data"));
}

new Html5QrcodeScanner("reader",{fps:10,qrbox:250})
.render(onScanSuccess);

function loadData(){
  fetch(scriptURL)
  .then(res=>res.json())
  .then(data=>{
    const bulan=document.getElementById("bulan").value;
    const tbody=document.getElementById("rekap");
    tbody.innerHTML="";

    let totalHadir=0;
    let totalTerlambat=0;

    data.forEach(row=>{
      const id=row[1];
      const nama=row[2];
      const tanggal=row[3];
      const jam=row[4];
      const status=row[5];

      if(tanggal.startsWith(bulan)){
        if(status==="Hadir") totalHadir++;
        if(status==="Terlambat") totalTerlambat++;

        tbody.innerHTML+=`
          <tr>
            <td>${id}</td>
            <td>${nama}</td>
            <td>${jam}</td>
            <td style="color:${status=="Terlambat"?"red":"green"}">
              ${status}
            </td>
          </tr>
        `;
      }
    });

    document.getElementById("totalHadir").innerText=totalHadir;
    document.getElementById("totalTerlambat").innerText=totalTerlambat;

    if(chartInstance){chartInstance.destroy();}
    chartInstance=new Chart(document.getElementById("chart"),{
      type:"doughnut",
      data:{
        labels:["Hadir","Terlambat"],
        datasets:[{
          data:[totalHadir,totalTerlambat],
          backgroundColor:["#2ecc71","#e74c3c"]
        }]
      }
    });
  });
}

</script>

</body>
</html>

